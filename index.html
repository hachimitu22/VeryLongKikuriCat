<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
      body {
        margin: 0px;
      }
      header {
        position: fixed;
        top: 0px;
        left: 0px;
      }
      #contents {
        text-align: right;
      }
      .kikuri-img {
        padding: 0;
        margin: 0;
        vertical-align: middle;
      }
      #twitter-share-button {
        border: none;
        font-size: 1.5em;
        background-color: #1DA1F2;
        padding: 6px 16px;
        border-radius: 100vh;
        color: white;
        cursor: pointer;
      }
    </style>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script type="text/javascript">
      function canScrollVertical(element) {
        return element.scrollHeight > element.clientHeight;
      }
      function addSquare(target) {
        const template = document.getElementById('template-kikuri-loop');
        const clone = template.content.cloneNode(true);
        target.appendChild(clone);
      }
      function stretchContents() {
        const contents = document.getElementById('contents');
        while(!canScrollVertical(document.documentElement)) {
          addSquare(contents);
        }
      }

      function setScore(score) {
        const scoreElement = document.getElementById('score');
        scoreElement.innerText = score;
      }

      function getScore() {
        const scoreElement = document.getElementById('score');
        return Number(scoreElement.innerText);
      }

      window.onload = () => {
        addSquare(contents);
        stretchContents();

        document.onscroll = function () {
          const bottom = document.documentElement.scrollTop + document.documentElement.clientHeight;
          const line = document.documentElement.scrollHeight - 200;

          if(line < bottom) {
            addSquare(contents);
          }

          const nextScore = Math.floor(window.scrollY);
          const score = getScore();
          if(nextScore > score) {
            setScore(nextScore);
          }
        };

        window.onresize = function() {
          stretchContents();
        };

        document.getElementById("twitter-share-button").onclick = function() {
          const url = new URL('https://twitter.com/share');
          url.searchParams.append('text', getScore());
          url.searchParams.append('hashtags', 'VeryLongKikuriCat');
          url.searchParams.append('url', encodeURIComponent(location.href));
          window.open(url.href);
        }

        document.getElementById('download').onclick = function() {
          const bottom = document.createElement( 'img' );
          bottom.addEventListener('load', () => {
            // find image
            const top = Array.from(window.document.images).filter(img => img.src.includes('kikuri_top.png'))[0];
            const loops = Array.from(window.document.images).filter(img => img.src.includes('kikuri_loop.png'));
            const images = [top, ...loops, bottom];

            // set height
            const topHeight = top.height;
            const loopsHeight = loops.length * loops[0].height;
            const bottomHeight = bottom.height;
            const width = top.height;

            // create canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = topHeight + loopsHeight + bottomHeight;
            canvas.width = width;
            images.reduce((heightOffset, cur) => {
              ctx.drawImage(cur, 0, heightOffset);
              return heightOffset + cur.height;
            }, 0);

            // download start
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "test.png";
            link.click();
          });
          bottom.src = './assets/img/kikuri_bottom.png';
        };
      };
    </script>
  </head>
  <body>
    <template id="template-kikuri-loop">
      <div class="kikuri kikuri-loop">
        <img src="./assets/img/kikuri_loop.png" class="kikuri-img">
      </div>
    </template>

    <header>
      <div id="score">0</div>
      <div class="tweet" id="tweet">
        <button id="twitter-share-button"><i class="fab fa-twitter"></i></button>
      </div>
      <button id="download">download</button>
    </header>
    <div id="contents">
      <div class="kikuri kikuri-top">
        <img src="./assets/img/kikuri_top.png" class="kikuri-img">
      </div>
    </div>
  </body>
</html>